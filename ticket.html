<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Linear Desk — Ticket</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --text:#e5e7eb; --primary:#6ee7b7; --accent:#60a5fa; --danger:#f87171; --border:#1f2937;
    }
    html,body{margin:0; height:100%; background:var(--bg); color:var(--text); font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
    .wrap{max-width:980px; margin:28px auto; padding:0 16px;}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px;}
    h1{font-size:20px; margin:0 0 8px}
    h2{font-size:16px; margin:18px 0 8px; color:var(--muted)}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:#0b1730}
    .pill.public{border-color:rgba(110,231,183,.35)}
    .pill.internal{border-color:rgba(96,165,250,.35)}
    .muted{color:var(--muted)}
    .btn{background:#111827; color:#fff; border:none; border-radius:10px; padding:8px 12px; cursor:pointer}
    .btn.secondary{background:#0b1730}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .input, textarea{width:100%; color:var(--text); background:#0b1730; border:1px solid var(--border); border-radius:10px; padding:8px}
    .comment{border:1px solid var(--border); border-radius:12px; padding:12px; margin:10px 0; background:#0a1428}
    .attachments{margin-top:6px; font-size:13px}
    .inline-img{display:block; max-width:280px; max-height:180px; border-radius:8px; border:1px solid var(--border); margin:8px 0}
    .dl{display:inline-flex; align-items:center; gap:8px; margin:6px 6px 0 0}
    .dl a{color:#cbd5e1; text-decoration:none; border:1px solid var(--border); padding:6px 10px; border-radius:8px}
    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:16px}
    @media (max-width: 820px){ .grid{grid-template-columns: 1fr} }
    .status{font-size:12px; color:var(--muted); margin-left:8px}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0b1730; border:1px solid var(--border); padding:0 6px; border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <h1 id="title">Ticket</h1>
        <span class="pill" id="number"></span>
        <span class="pill" id="state"></span>
      </div>
      <div class="muted" id="subtitle"></div>
    </div>

    <div class="grid" style="margin-top:16px;">
      <!-- Left column: conversation -->
      <div class="card">
        <h2>Conversation</h2>
        <div id="comments">Loading…</div>
      </div>

      <!-- Right column: actions -->
      <div class="card">
        <h2>Reply to client</h2>
        <textarea id="reply-text" rows="5" placeholder="Write your reply to the client…"></textarea>
        <div style="margin-top:10px;">
          <input id="reply-files" type="file" multiple />
          <div id="file-list" class="muted" style="margin-top:6px;"></div>
        </div>
        <div class="row" style="margin-top:12px;">
          <button id="send-reply" class="btn">Send reply</button>
          <span id="reply-status" class="status"></span>
        </div>

        <h2 style="margin-top:22px;">Internal note</h2>
        <textarea id="note-text" rows="3" placeholder="Add an internal-only note…"></textarea>
        <div class="row" style="margin-top:10px;">
          <button id="add-note" class="btn secondary">Add note</button>
          <span id="note-status" class="status"></span>
        </div>

        <div style="margin-top:16px;" class="muted">
          <div><span class="kbd">Tip</span> Attachments are sent to the client and logged. Max 5 MB per file, 10 MB total.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const API = "https://api.help.linearit.co";
    const params = new URLSearchParams(location.search);
    const TICKET_ID = (params.get("id") || "").trim();

    // ===== Auth guard: if not logged in, send them to /admin to login once =====
    (async () => {
      try {
        const r = await fetch(`${API}/admin/diag`, { credentials: "include" });
        if (r.status === 401) {
          // Not logged in — redirect to admin login page (single sign-in)
          location.href = "/admin";
          return;
        }
        // else we’re logged in; continue
        init();
      } catch {
        // Network error — still try init so you see a meaningful message
        init();
      }
    })();

    // ===== Page logic =====
    let $title,$number,$state,$subtitle,$comments,$replyText,$replyFiles,$fileList,$sendReply,$replyStatus,$noteText,$addNote,$noteStatus;

    function q(id){ return document.getElementById(id); }
    function humanBytes(n){ if(!n && n!==0) return ""; const mb = n/1024/1024; return mb>=1? mb.toFixed(2)+" MB" : (n/1024).toFixed(0)+" KB"; }
    function escapeHtml(s){ return (s||"").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    function makeBlobUrl(b64, mime) {
      try {
        const bin = atob(b64);
        const len = bin.length;
        const buf = new Uint8Array(len);
        for (let i=0; i<len; i++) buf[i] = bin.charCodeAt(i);
        const blob = new Blob([buf], { type: mime || "application/octet-stream" });
        return URL.createObjectURL(blob);
      } catch(e) { return "#"; }
    }

    function renderCommentBody(body){
      const lines = (body||"").split(/\r?\n/);
      const first = (lines[0]||"").trim();
      let type = "other";
      if(/^PUBLIC:/.test(first)) type = "public";
      if(/^INTERNAL:/.test(first)) type = "internal";

      const attachData = [];
      const htmlParts = [];

      for (const line of lines){
        // Inline image markdown data: URIs
        if (/!\[[^\]]*]\(data:[^)]+\)/.test(line)) {
          const m = line.match(/!\[([^\]]*)]\((data:[^)]+)\)/);
          if (m) { htmlParts.push(`<img class="inline-img" alt="${escapeHtml(m[1])}" src="${m[2]}">`); continue; }
        }

        if (/^\*\*Attachments:\*\*/.test(line)) { htmlParts.push(`<div class="attachments"><strong>Attachments:</strong></div>`); continue; }
        if (/^\- /.test(line)) { htmlParts.push(`<div class="attachments">${escapeHtml(line)}</div>`); continue; }

        if (/^ATTACH-DATA:/.test(line)) {
          const rest = line.replace(/^ATTACH-DATA:/, "");
          const [name="", type="application/octet-stream", sizeStr="0", b64=""] = rest.split("|");
          const size = parseInt(sizeStr,10) || 0;
          if (b64) attachData.push({ name, type, size, b64 });
          continue;
        }

        // Regular text
        htmlParts.push(`<div>${escapeHtml(line)}</div>`);
      }

      if (attachData.length > 0) {
        htmlParts.push(`<div class="attachments">`);
        for (const a of attachData) {
          const href = makeBlobUrl(a.b64, a.type);
          const label = `${a.name} • ${a.type} • ${humanBytes(a.size)}`;
          htmlParts.push(`<span class="dl"><a href="${href}" download="${escapeHtml(a.name)}">Download ${escapeHtml(label)}</a></span>`);
        }
        htmlParts.push(`</div>`);
      }

      return { type, html: htmlParts.join("") };
    }

    function renderComments(issue, comments){
      $comments.innerHTML = "";
      const header = document.createElement("div");
      header.className = "comment";
      header.innerHTML = `<div class="pill">Issue body</div><div style="height:6px"></div>${renderCommentBody(issue.body||"").html}`;
      $comments.appendChild(header);

      (comments||[]).forEach(c=>{
        const { type, html } = renderCommentBody(c.body||"");
        const div = document.createElement("div");
        div.className = "comment";
        const badge = type==="public" ? `<span class="pill public">PUBLIC</span>` :
                      type==="internal" ? `<span class="pill internal">INTERNAL</span>` :
                      `<span class="pill">Comment</span>`;
        div.innerHTML = `${badge}<div style="height:6px"></div>${html}`;
        $comments.appendChild(div);
      });
    }

    async function fetchTicket(){
      if (!/^\d+$/.test(TICKET_ID)) { $comments.textContent = "Missing or invalid ?id= in URL"; return; }
      const r = await fetch(`${API}/admin/tickets/${TICKET_ID}`, { credentials:"include" });
      if (r.status === 401) { location.href = "/admin"; return; }
      const j = await r.json().catch(()=>({}));
      if (!r.ok || !j.issue) { $comments.textContent = "Failed to load ticket."; return; }
      const issue = j.issue;
      $title.textContent = issue.title || `Ticket #${TICKET_ID}`;
      $number.textContent = `#${TICKET_ID}`;
      $state.textContent = issue.state || "open";
      $subtitle.textContent = `Updated ${new Date(issue.updated_at||Date.now()).toLocaleString()}`;
      renderComments(issue, j.comments || []);
    }

    function renderFileList(){
      const files = Array.from($replyFiles.files||[]);
      if (files.length===0){ $fileList.textContent=""; return; }
      let total=0;
      $fileList.innerHTML = files.map(f=>{
        total += f.size||0;
        return `<div>${escapeHtml(f.name)} — ${escapeHtml(f.type||"application/octet-stream")} — ${escapeHtml(humanBytes(f.size))}</div>`;
      }).join("") + `<div><em>Total: ${humanBytes(total)}</em></div>`;
    }

    function fileToBase64(file){
      return new Promise((res, rej)=>{
        const fr = new FileReader();
        fr.onload = ()=> res(String(fr.result).split(",")[1]||"");
        fr.onerror = rej;
        fr.readAsDataURL(file);
      });
    }

    async function sendReply(){
      const MAX_PER_FILE = 5*1024*1024, MAX_TOTAL = 10*1024*1024;
      const text = ($replyText.value||"").trim();
      const files = Array.from($replyFiles.files||[]);
      let total=0;
      for (const f of files){
        if ((f.size||0) > MAX_PER_FILE){ $replyStatus.textContent=`File too large: ${f.name}`; return; }
        total += f.size||0;
      }
      if (total > MAX_TOTAL){ $replyStatus.textContent=`Total attachments exceed 10 MB`; return; }

      $replyStatus.textContent = "Encoding attachments…";
      $sendReply.disabled = true;

      try {
        const attachments = [];
        for (const f of files){
          const base64 = await fileToBase64(f);
          attachments.push({ filename:f.name||"attachment", contentType:f.type||"application/octet-stream", base64 });
        }

        $replyStatus.textContent = "Sending…";
        const resp = await fetch(`${API}/admin/tickets/${TICKET_ID}/reply`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          credentials:"include",
          body: JSON.stringify({ text, attachments })
        });
        const jr = await resp.json().catch(()=>({}));
        if (!resp.ok){
          $replyStatus.textContent = `Error: ${jr.error || resp.status}`;
        } else {
          await fetchTicket();
          $replyText.value=""; $replyFiles.value=""; renderFileList();
          if (jr.email && jr.email.ok) $replyStatus.textContent = "Sent ✓";
          else if (jr.email && jr.email.status) $replyStatus.textContent = `Sent? Resend status ${jr.email.status}`;
          else $replyStatus.textContent = "Logged. Email skipped (config/client email).";
        }
      } catch(e){
        $replyStatus.textContent = "Network error";
      } finally {
        $sendReply.disabled = false;
      }
    }

    async function sendNote(){
      const text = ($noteText.value||"").trim();
      if (!text){ $noteStatus.textContent="Type something first"; return; }
      $addNote.disabled = true; $noteStatus.textContent="Saving…";
      try{
        const r = await fetch(`${API}/admin/tickets/${TICKET_ID}/comment`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          credentials:"include",
          body: JSON.stringify({ text })
        });
        const j = await r.json().catch(()=>({}));
        if (!r.ok){ $noteStatus.textContent = `Error: ${j.error || r.status}`; }
        else { $noteText.value=""; $noteStatus.textContent="Added ✓"; await fetchTicket(); }
      }catch(e){ $noteStatus.textContent="Network error"; }
      finally{ $addNote.disabled = false; }
    }

    function init(){
      // Bind DOM
      $title=q("title"); $number=q("number"); $state=q("state"); $subtitle=q("subtitle"); $comments=q("comments");
      $replyText=q("reply-text"); $replyFiles=q("reply-files"); $fileList=q("file-list"); $sendReply=q("send-reply"); $replyStatus=q("reply-status");
      $noteText=q("note-text"); $addNote=q("add-note"); $noteStatus=q("note-status");

      // Events
      $replyFiles.addEventListener("change", renderFileList);
      $sendReply.addEventListener("click", sendReply);
      $addNote.addEventListener("click", sendNote);

      // Load
      fetchTicket();
    }
  </script>
</body>
</html>
