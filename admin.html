<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Linear Desk — Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e5e7eb;--border:#1f2937;--accent:#6ee7b7}
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1200px;margin:26px auto;padding:0 16px}
    header{display:flex;gap:10px;align-items:center;margin-bottom:12px}
    h1{font-size:20px;margin:0}
    .pill{font-size:12px;border:1px solid var(--border);border-radius:999px;padding:4px 8px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:16px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
    input,textarea,select{width:100%;background:#0b1730;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px}
    button{background:#111827;color:#fff;border:none;border-radius:10px;padding:8px 12px;cursor:pointer}
    button:hover{background:#1f2937}
    .list{max-height:70vh;overflow:auto}
    .item{border:1px solid var(--border);border-radius:10px;padding:10px;margin:8px 0;background:#0b1427;cursor:pointer}
    .item:hover{outline:1px solid #1f2d47}
    .muted{color:var(--muted)}
    .comment{border:1px solid var(--border);border-radius:10px;padding:10px;margin:10px 0;background:#0a1428}
    .badge{display:inline-block;border:1px solid var(--border);border-radius:8px;padding:2px 6px;margin-right:6px;font-size:12px}
    .badge.public{border-color:rgba(34,197,94,.45)}
    .badge.internal{border-color:rgba(96,165,250,.45)}
    .attachments{margin-top:8px}
    .dl{display:inline-flex;align-items:center;gap:8px;margin:6px 8px 0 0}
    .dl a{color:#e5e7eb;text-decoration:none;border:1px solid var(--border);padding:6px 10px;border-radius:8px}
    .inline-img{display:block;max-width:280px;max-height:180px;border-radius:8px;border:1px solid var(--border);margin:8px 0}
    #loginBox{max-width:420px;margin:80px auto}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  </style>
</head>
<body>
<div class="wrap">

  <!-- Login -->
  <div id="loginBox" class="panel" style="display:none;">
    <h2>Staff Login</h2>
    <input id="pw" type="password" placeholder="Enter staff password"/>
    <div class="row" style="margin-top:10px">
      <button id="btnLogin">Login</button>
      <span id="loginMsg" class="muted"></span>
    </div>
  </div>

  <!-- Admin app -->
  <div id="app" style="display:none;">
    <header>
      <h1>Linear Desk — Admin</h1>
      <span class="pill" id="whoami"></span>
      <span class="pill" id="sess"></span>
      <span class="pill" id="allow"></span>
      <span style="flex:1"></span>
      <button id="btnLogout" title="Show login">Logout</button>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <div class="panel">
        <div class="row" style="margin-bottom:8px">
          <input id="q" type="text" placeholder="Search…"/>
          <button id="btnSearch">Search</button>
          <button id="btnOpen">Open</button>
          <button id="btnClosed">Closed</button>
          <button id="btnRefresh">Refresh</button>
        </div>
        <div class="list" id="list">Loading…</div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <div>
            <div id="tTitle" style="font-weight:600">Select a ticket…</div>
            <div class="muted" id="tMeta"></div>
          </div>
          <div class="row">
            <select id="statusSel" style="width:auto;min-width:150px">
              <option value="">Set status…</option>
              <option>new</option>
              <option>waiting</option>
              <option>working</option>
              <option>done</option>
            </select>
            <button id="btnSetStatus">Save</button>
          </div>
        </div>

        <div class="muted" style="margin:8px 0">Conversation</div>
        <div id="comments">—</div>

        <div class="muted" style="margin:14px 0 6px">Reply to client</div>
        <textarea id="replyText" rows="4" placeholder="Write your reply…"></textarea>
        <div class="row" style="margin-top:8px">
          <input id="replyFiles" type="file" multiple/>
          <span id="fileList" class="muted"></span>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="btnSend">Send reply</button>
          <span id="sendStatus" class="muted"></span>
        </div>

        <div class="muted" style="margin:16px 0 6px">Internal note</div>
        <textarea id="noteText" rows="3" placeholder="Add an internal-only note…"></textarea>
        <div class="row" style="margin-top:10px">
          <button id="btnNote">Add note</button>
          <span id="noteStatus" class="muted"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const API="https://api.help.linearit.co";
const $=id=>document.getElementById(id);

// ----- login / diag -----
async function diag(){
  const r=await fetch(`${API}/admin/diag`,{credentials:"include"});
  if(r.status===401){ showLogin(); return false; }
  const j=await r.json().catch(()=>({}));
  $("whoami").textContent=j.hasStaffPassword?"auth:enabled":"auth:missing";
  $("sess").textContent=j.hasSessionSecret?`sess:${j.sessionLen}`:"sess:missing";
  $("allow").textContent=j.allowOrigin||"*";
  showApp();
  return true;
}
function showLogin(){ $("loginBox").style.display="block"; $("app").style.display="none"; }
function showApp(){ $("loginBox").style.display="none"; $("app").style.display="block"; }

$("btnLogin").onclick=async()=>{
  const pw=$("pw").value.trim();
  $("loginMsg").textContent="Logging in…";
  const r=await fetch(`${API}/admin/login`,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({password:pw}),credentials:"include"
  });
  const j=await r.json().catch(()=>({}));
  if(j.ok){
    $("loginMsg").textContent="Success!";
    window.location.href="/admin.html"; // land here after login
  } else $("loginMsg").textContent="Unauthorized.";
};
$("btnLogout").onclick=()=>{ showLogin(); };

// ----- utils -----
function esc(s){return (s||"").replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}
function humanBytes(n){if(n===0)return"0 B";if(!n)return"";const u=['B','KB','MB','GB'];let i=0;while(n>=1024&&i<u.length-1){n/=1024;i++}return n.toFixed(i?1:0)+" "+u[i]}
function blobUrlFromBase64(b64,mime){
  try{
    const bin=atob(b64); const buf=new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) buf[i]=bin.charCodeAt(i);
    return URL.createObjectURL(new Blob([buf],{type:mime||"application/octet-stream"}));
  }catch(e){return"#"}
}

// Parse our attachment markers and turn them into UI
function parseCommentBodyToHTML(body){
  const lines=(body||"").split(/\r?\n/);
  let html=[];
  let pendingAtts=[];

  for(const line of lines){
    if(line.startsWith("ATTACH-DATA:")){
      const rest=line.replace("ATTACH-DATA:","");
      const [name="",mime="application/octet-stream",sizeStr="0",b64=""] = rest.split("|");
      const size = parseInt(sizeStr,10)||0;
      const href = b64 ? blobUrlFromBase64(b64, mime) : "#";
      const label = `${name} • ${mime} • ${humanBytes(size)}`;
      pendingAtts.push({href,name,label,download:true});
      continue;
    }
    if(line.startsWith("ATTACH-NOINLINE:")){
      const rest=line.replace("ATTACH-NOINLINE:","");
      const [name="",mime="application/octet-stream",sizeStr="0"] = rest.split("|");
      const size = parseInt(sizeStr,10)||0;
      const label = `${name} • ${mime} • ${humanBytes(size)} (not inlined)`;
      pendingAtts.push({href:"#",name,label,download:false});
      continue;
    }
    // Inline image data:url from email path
    const m=line.match(/!\[([^\]]*)]\((data:[^)]+)\)/);
    if(m){ html.push(`<img class="inline-img" alt="${esc(m[1])}" src="${m[2]}">`); continue; }

    html.push(`<div>${esc(line)}</div>`);
  }

  if(pendingAtts.length>0){
    const parts = pendingAtts.map(a=>{
      if(a.download){
        return `<span class="dl"><a href="${a.href}" download="${esc(a.name)}">Download ${esc(a.label)}</a></span>`;
      }else{
        return `<span class="dl"><a href="javascript:void(0)" title="Large file not stored">Attachment: ${esc(a.label)}</a></span>`;
      }
    });
    html.push(`<div class="attachments">${parts.join("")}</div>`);
  }

  return html.join("");
}

function renderComments(issue,comments){
  const box=$("comments"); box.innerHTML="";
  const d0=document.createElement("div"); d0.className="comment";
  d0.innerHTML=`<span class="badge">Issue body</span><div style="height:6px"></div>${parseCommentBodyToHTML(issue.body||"")}`;
  box.appendChild(d0);
  (comments||[]).forEach(c=>{
    const first=(c.body||"").split(/\r?\n/,1)[0]||"";
    const type = first.startsWith("PUBLIC:") ? "public" : first.startsWith("INTERNAL:") ? "internal" : "comment";
    const badge = type==="public" ? `<span class="badge public">PUBLIC</span>` :
                  type==="internal" ? `<span class="badge internal">INTERNAL</span>` :
                  `<span class="badge">Comment</span>`;
    const d=document.createElement("div"); d.className="comment";
    d.innerHTML=`${badge}<div style="height:6px"></div>${parseCommentBodyToHTML(c.body||"")}`;
    box.appendChild(d);
  });
}

// ----- list & view -----
const $q=$("q"), $list=$("list"), $statusSel=$("statusSel"), $btnSetStatus=$("btnSetStatus");
const $replyText=$("replyText"), $replyFiles=$("replyFiles"), $fileList=$("fileList");
const $btnSend=$("btnSend"), $sendStatus=$("sendStatus");
const $noteText=$("noteText"), $btnNote=$("btnNote"), $noteStatus=$("noteStatus");

function setHashTicket(n){location.hash = n? `ticket=${n}` : "";}
function getHashTicket(){const m=location.hash.match(/ticket=(\d+)/);return m?m[1]:null;}

async function listTickets(view="open", q=""){
  if(q){
    const r=await fetch(`${API}/admin/tickets?view=search&q=${encodeURIComponent(q)}`,{credentials:"include"});
    const j=await r.json(); return j.items||[];
  }
  const params=new URLSearchParams(); params.set("state", view==="closed"?"closed":"open");
  const r=await fetch(`${API}/admin/tickets?${params}`,{credentials:"include"});
  const j=await r.json(); return j.items||j;
}
async function refreshList(kind){
  $list.textContent="Loading…";
  try{
    const items=await listTickets(kind||"open",$q.value.trim());
    if(items.length===0){$list.textContent="No tickets.";return;}
    $list.innerHTML="";
    for(const it of items){
      const div=document.createElement("div"); div.className="item";
      div.innerHTML=`<div style="font-weight:600">${(it.title||"(no title)") } <span class="muted">#${it.number}</span></div>
                     <div class="muted">${(it.labels||[]).map(l=>l.name).join(", ")}</div>`;
      div.onclick=()=>loadTicket(it.number);
      $list.appendChild(div);
    }
  }catch{ $list.textContent="Failed to load list."; }
}
async function loadTicket(n){
  const r=await fetch(`${API}/admin/tickets/${n}`,{credentials:"include"});
  const j=await r.json(); if(!j.ok){document.getElementById("tTitle").textContent="Error loading ticket";return;}
  const issue=j.issue, comments=j.comments||[];
  document.getElementById("tTitle").textContent=issue.title || `(no title)`;
  document.getElementById("tMeta").textContent=`#${n} • ${issue.state} • Updated ${new Date(issue.updated_at||issue.created_at).toLocaleString()}`;
  renderComments(issue,comments);
  window.currentTicket=n; setHashTicket(n);
}

// ----- status -----
$btnSetStatus.onclick=async()=>{
  if(!window.currentTicket) return;
  const status=$statusSel.value.trim(); if(!status) return;
  $btnSetStatus.disabled=true;
  try{
    const r=await fetch(`${API}/admin/tickets/${window.currentTicket}/status`,{
      method:"POST",headers:{"Content-Type":"application/json"},
      credentials:"include",body:JSON.stringify({status})
    });
    if(r.ok) await loadTicket(window.currentTicket);
    else alert("Status update failed");
  }finally{$btnSetStatus.disabled=false;}
};

// ----- attachments (compose) -----
function showChosenFiles(){
  const files=Array.from($replyFiles.files||[]); if(files.length===0){$fileList.textContent="";return;}
  let total=0;
  $fileList.innerHTML=files.map(f=>{total+=f.size||0;return `${f.name} — ${(f.type||"application/octet-stream")} — ${humanBytes(f.size)}`}).join(" | ");
  $fileList.innerHTML+=` <em>(Total ${humanBytes(total)})</em>`;
}
$replyFiles.onchange=showChosenFiles;

// ----- send reply (multipart) -----
$btnSend.onclick=async()=>{
  if(!window.currentTicket) return;
  const text=($replyText.value||"").trim();
  const files=Array.from($replyFiles.files||[]);
  if(!text && files.length===0){$sendStatus.textContent="Type a reply or attach a file.";return;}

  const fd=new FormData(); fd.append("text",text); for(const f of files) fd.append("files",f);
  $btnSend.disabled=true; $sendStatus.textContent="Sending…";
  try{
    const r=await fetch(`${API}/admin/tickets/${window.currentTicket}/reply`,{method:"POST",body:fd,credentials:"include"});
    const j=await r.json().catch(()=>({}));
    if(!r.ok){$sendStatus.textContent=`Error ${r.status}`;}
    else{
      $replyText.value=""; $replyFiles.value=""; showChosenFiles();
      await loadTicket(window.currentTicket);
      if(j.email && j.email.ok) $sendStatus.textContent="Sent ✓";
      else if(j.email && j.email.status) $sendStatus.textContent=`Resend: ${j.email.status}`;
      else $sendStatus.textContent="Logged only.";
    }
  }catch{ $sendStatus.textContent="Network error"; }
  finally{ $btnSend.disabled=false; }
};

// ----- internal note -----
$btnNote.onclick=async()=>{
  if(!window.currentTicket) return;
  const text=($noteText.value||"").trim(); if(!text){$noteStatus.textContent="Type something";return;}
  $btnNote.disabled=true; $noteStatus.textContent="Saving…";
  try{
    const r=await fetch(`${API}/admin/tickets/${window.currentTicket}/comment`,{
      method:"POST",headers:{"Content-Type":"application/json"},
      credentials:"include",body:JSON.stringify({text})
    });
    if(r.ok){$noteText.value=""; await loadTicket(window.currentTicket); $noteStatus.textContent="Added ✓";}
    else $noteStatus.textContent="Error";
  }catch{ $noteStatus.textContent="Network error"; }
  finally{$btnNote.disabled=false;}
};

// ----- search & filters -----
$("btnSearch").onclick=()=>refreshList("search");
$("btnOpen").onclick=()=>{ $("q").value=""; refreshList("open"); };
$("btnClosed").onclick=()=>{ $("q").value=""; refreshList("closed"); };
$("btnRefresh").onclick=()=>refreshList();

// init
(async function(){
  const ok=await diag();
  if(!ok) return;
  await refreshList("open");
  const m=location.hash.match(/ticket=(\d+)/); if(m) loadTicket(m[1]);
})();
</script>
</body>
</html>
