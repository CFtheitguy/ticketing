<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Linear Desk — Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e5e7eb;--border:#1f2937}
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    h1{font-size:20px;margin:0}
    .pill{font-size:12px;border:1px solid var(--border);border-radius:999px;padding:4px 8px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:16px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
    .section-title{font-size:13px;color:var(--muted);margin:6px 0 10px}
    .search{display:flex;gap:8px}
    input[type="text"],textarea,select{width:100%;background:#0b1730;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px}
    button{background:#111827;color:#fff;border:none;border-radius:10px;padding:8px 12px;cursor:pointer}
    button:hover{background:#1f2937}
    button:disabled{opacity:.6;cursor:not-allowed}
    .list{max-height:70vh;overflow:auto}
    .item{border:1px solid var(--border);border-radius:10px;padding:10px;margin:8px 0;background:#0b1427;cursor:pointer}
    .item:hover{outline:1px solid #1f2d47}
    .muted{color:#94a3b8}
    .comment{border:1px solid var(--border);border-radius:10px;padding:10px;margin:10px 0;background:#0a1428}
    .badge{display:inline-block;border:1px solid var(--border);border-radius:8px;padding:2px 6px;margin-right:6px;font-size:12px}
    .badge.public{border-color:rgba(34,197,94,.4)}
    .badge.internal{border-color:rgba(96,165,250,.4)}
    .attachments{margin-top:6px;font-size:13px}
    .dl{display:inline-flex;align-items:center;gap:8px;margin:6px 6px 0 0}
    .dl a{color:#cbd5e1;text-decoration:none;border:1px solid var(--border);padding:6px 10px;border-radius:8px}
    .inline-img{display:block;max-width:280px;max-height:180px;border-radius:8px;border:1px solid var(--border);margin:8px 0}
    #loginBox{max-width:420px;margin:80px auto}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  </style>
</head>
<body>
<div class="wrap">

  <!-- Login -->
  <div id="loginBox" class="panel" style="display:none;">
    <h2>Staff Login</h2>
    <input id="pw" type="password" placeholder="Enter staff password"/>
    <div class="row" style="margin-top:10px">
      <button id="btnLogin">Login</button>
      <span id="loginMsg" class="muted"></span>
    </div>
  </div>

  <!-- Admin app -->
  <div id="app" style="display:none;">
    <header>
      <h1>Linear Desk — Admin</h1>
      <span class="pill" id="whoami"></span>
      <span class="pill" id="sess"></span>
      <span class="pill" id="allow"></span>
      <span style="flex:1"></span>
      <button id="btnLogout">Logout</button>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <div class="panel">
        <div class="section-title">Tickets</div>
        <div class="search">
          <input id="q" type="text" placeholder="Search…"/>
          <button id="btnSearch">Search</button>
          <button id="btnOpen">Open</button>
          <button id="btnClosed">Closed</button>
          <button id="btnRefresh">Refresh</button>
        </div>
        <div class="list" id="list">Loading…</div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <div>
            <div id="tTitle" style="font-weight:600">Select a ticket…</div>
            <div class="muted" id="tMeta"></div>
          </div>
          <div class="row">
            <select id="statusSel" style="width:auto;min-width:150px">
              <option value="">Set status…</option>
              <option>new</option>
              <option>waiting</option>
              <option>working</option>
              <option>done</option>
            </select>
            <button id="btnSetStatus">Save</button>
          </div>
        </div>

        <div class="section-title">Conversation</div>
        <div id="comments">—</div>

        <div class="section-title">Reply to client</div>
        <textarea id="replyText" rows="5" placeholder="Write your reply…"></textarea>
        <div class="row" style="margin-top:8px">
          <input id="replyFiles" type="file" multiple/>
          <span id="fileList" class="muted"></span>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="btnSend">Send reply</button>
          <span id="sendStatus" class="muted"></span>
        </div>

        <div class="section-title" style="margin-top:16px">Internal note</div>
        <textarea id="noteText" rows="3" placeholder="Add an internal-only note…"></textarea>
        <div class="row" style="margin-top:10px">
          <button id="btnNote">Add note</button>
          <span id="noteStatus" class="muted"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const API="https://api.help.linearit.co";
const $=id=>document.getElementById(id);

// ----- login / diag -----
async function diag(){
  const r=await fetch(`${API}/admin/diag`,{credentials:"include"});
  if(r.status===401){ showLogin(); return false; }
  const j=await r.json().catch(()=>({}));
  $("whoami").textContent=j.hasStaffPassword?"auth:enabled":"auth:missing";
  $("sess").textContent=j.hasSessionSecret?`sess:${j.sessionLen}`:"sess:missing";
  $("allow").textContent=j.allowOrigin||"*";
  showApp();
  return true;
}
function showLogin(){ $("loginBox").style.display="block"; $("app").style.display="none"; }
function showApp(){ $("loginBox").style.display="none"; $("app").style.display="block"; }

$("btnLogin").onclick=async()=>{
  const pw=$("pw").value.trim();
  $("loginMsg").textContent="Logging in…";
  const r=await fetch(`${API}/admin/login`,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({password:pw}),credentials:"include"
  });
  const j=await r.json().catch(()=>({}));
  if(j.ok){
    $("loginMsg").textContent="Success!";
    // Ensure we land on admin, not the public form
    window.location.href="/admin.html";
  } else $("loginMsg").textContent="Unauthorized.";
};

$("btnLogout").onclick=()=>{ showLogin(); };

// ----- utils -----
function esc(s){return (s||"").replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}
function humanBytes(n){if(n===0)return"0 B";if(!n)return"";const u=['B','KB','MB','GB'];let i=0;while(n>=1024&&i<u.length-1){n/=1024;i++}return n.toFixed(i?1:0)+" "+u[i]}
function makeBlobUrl(b64,mime){try{const bin=atob(b64),buf=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)buf[i]=bin.charCodeAt(i);return URL.createObjectURL(new Blob([buf],{type:mime||"application/octet-stream"}));}catch{return"#"}}
function parseCommentBody(body){
  const lines=(body||"").split(/\r?\n/);
  const first=(lines[0]||"").trim();
  let type="comment";
  if(/^PUBLIC:/.test(first)) type="public";
  if(/^INTERNAL:/.test(first)) type="internal";
  const html=[]; const atts=[];
  for(const line of lines){
    if(/^ATTACH-DATA:/.test(line)){
      const rest=line.replace(/^ATTACH-DATA:/,"");
      const [name="", mime="application/octet-stream", size="0", b64=""] = rest.split("|");
      if(b64) atts.push({name,mime,size:parseInt(size,10)||0,b64});
      continue;
    }
    if(/!\[[^\]]*]\(data:[^)]+\)/.test(line)){
      const m=line.match(/!\[([^\]]*)]\((data:[^)]+)\)/);
      if(m){ html.push(`<img class="inline-img" alt="${esc(m[1])}" src="${m[2]}">`); continue; }
    }
    html.push(`<div>${esc(line)}</div>`);
  }
  if(atts.length>0){
    html.push(`<div class="attachments">`);
    for(const a of atts){
      const href=makeBlobUrl(a.b64,a.mime);
      const label=`${a.name} • ${a.mime} • ${humanBytes(a.size)}`;
      html.push(`<span class="dl"><a href="${href}" download="${esc(a.name)}">Download ${esc(label)}</a></span>`);
    }
    html.push(`</div>`);
  }
  return {type, html:html.join("")};
}
function renderComments(issue,comments){
  const box=$("comments"); box.innerHTML="";
  const d0=document.createElement("div"); d0.className="comment";
  d0.innerHTML=`<span class="badge">Issue body</span><div style="height:6px"></div>${parseCommentBody(issue.body||"").html}`;
  box.appendChild(d0);
  (comments||[]).forEach(c=>{
    const {type,html}=parseCommentBody(c.body||"");
    const d=document.createElement("div"); d.className="comment";
    const badge= type==="public" ? `<span class="badge public">PUBLIC</span>` :
                  type==="internal" ? `<span class="badge internal">INTERNAL</span>` :
                  `<span class="badge">Comment</span>`;
    d.innerHTML=`${badge}<div style="height:6px"></div>${html}`;
    box.appendChild(d);
  });
}

// ----- list & view -----
const $q=$("q"), $list=$("list"), $tTitle=$("tTitle"), $tMeta=$("tMeta");
const $statusSel=$("statusSel"), $btnSetStatus=$("btnSetStatus");
const $replyText=$("replyText"), $replyFiles=$("replyFiles"), $fileList=$("fileList");
const $btnSend=$("btnSend"), $sendStatus=$("sendStatus");
const $noteText=$("noteText"), $btnNote=$("btnNote"), $noteStatus=$("noteStatus");

async function listTickets(view="open", q=""){
  if(q){
    const r=await fetch(`${API}/admin/tickets?view=search&q=${encodeURIComponent(q)}`,{credentials:"include"});
    const j=await r.json(); if(!j.ok) throw new Error("Search failed"); return j.items||[];
  }
  const params=new URLSearchParams(); params.set("state", view==="closed"?"closed":"open");
  const r=await fetch(`${API}/admin/tickets?${params}`,{credentials:"include"});
  const j=await r.json(); if(!j.ok) throw new Error("List failed"); return j.items||j;
}
async function refreshList(kind){
  $list.textContent="Loading…";
  try{
    const items=await listTickets(kind||"open",$q.value.trim());
    if(items.length===0){$list.textContent="No tickets.";return;}
    $list.innerHTML="";
    for(const it of items){
      const div=document.createElement("div"); div.className="item";
      div.innerHTML=`<div style="font-weight:600">${(it.title||"(no title)") } <span class="muted">#${it.number}</span></div>
                     <div class="muted">${(it.labels||[]).map(l=>l.name).join(", ")}</div>`;
      div.onclick=()=>loadTicket(it.number);
      $list.appendChild(div);
    }
  }catch{ $list.textContent="Failed to load list."; }
}
async function loadTicket(n){
  const r=await fetch(`${API}/admin/tickets/${n}`,{credentials:"include"});
  const j=await r.json(); if(!j.ok){$tTitle.textContent="Error loading ticket";return;}
  const issue=j.issue, comments=j.comments||[];
  $("tTitle").textContent=issue.title || `(no title)`;
  $("tMeta").textContent=`#${n} • ${issue.state} • Updated ${new Date(issue.updated_at||issue.created_at).toLocaleString()}`;
  renderComments(issue,comments);
  window.currentTicket=n;
}

// ----- status -----
$btnSetStatus.onclick=async()=>{
  if(!window.currentTicket) return;
  const status=$statusSel.value.trim(); if(!status) return;
  $btnSetStatus.disabled=true;
  try{
    const r=await fetch(`${API}/admin/tickets/${window.currentTicket}/status`,{
      method:"POST",headers:{"Content-Type":"application/json"},
      credentials:"include",body:JSON.stringify({status})
    });
    if(!r.ok){alert("Status update failed");} else { await loadTicket(window.currentTicket); }
  }finally{$btnSetStatus.disabled=false;}
};

// ----- attachments (compose) -----
function showChosenFiles(){
  const files=Array.from($replyFiles.files||[]); if(files.length===0){$fileList.textContent="";return;}
  let total=0;
  $fileList.innerHTML=files.map(f=>{total+=f.size||0;return `${f.name} — ${(f.type||"application/octet-stream")} — ${humanBytes(f.size)}`}).join(" | ");
  $fileList.innerHTML+=` <em>(Total ${humanBytes(total)})</em>`;
}
$replyFiles.onchange=showChosenFiles;

// ----- send reply (multipart) -----
$btnSend.onclick=async()=>{
  if(!window.currentTicket) return;
  const text=($replyText.value||"").trim();
  const files=Array.from($replyFiles.files||[]);
  if(!text && files.length===0){$sendStatus.textContent="Type a reply or attach a file.";return;}

  const fd=new FormData();
  fd.append("text",text);
  for(const f of files) fd.append("files",f);

  $btnSend.disabled=true; $sendStatus.textContent="Sending…";
  try{
    const r=await fetch(`${API}/admin/tickets/${window.currentTicket}/reply`,{method:"POST",body:fd,credentials:"include"});
    const j=await r.json().catch(()=>({}));
    if(!r.ok){$sendStatus.textContent=`Error ${r.status}`;}
    else{
      $replyText.value=""; $replyFiles.value=""; showChosenFiles();
      await loadTicket(window.currentTicket);
      if(j.email && j.email.ok) $sendStatus.textContent="Sent ✓";
      else if(j.email && j.email.status) $sendStatus.textContent=`Resend: ${j.email.status}`;
      else $sendStatus.textContent="Logged only.";
    }
  }catch{ $sendStatus.textContent="Network error"; }
  finally{ $btnSend.disabled=false; }
};

// ----- internal note -----
$btnNote.onclick=async()=>{
  if(!window.currentTicket) return;
  const text=($noteText.value||"").trim(); if(!text){$noteStatus.textContent="Type something";return;}
  $btnNote.disabled=true; $noteStatus.textContent="Saving…";
  try{
    const r=await fetch(`${API}/admin/tickets/${window.currentTicket}/comment`,{
      method:"POST",headers:{"Content-Type":"application/json"},
      credentials:"include",body:JSON.stringify({text})
    });
    if(!r.ok){$noteStatus.textContent="Error";} else { $noteText.value=""; await loadTicket(window.currentTicket); $noteStatus.textContent="Added ✓"; }
  }catch{ $noteStatus.textContent="Network error"; }
  finally{$btnNote.disabled=false;}
};

// ----- search & filters -----
$("btnSearch").onclick=()=>refreshList("search");
$("btnOpen").onclick=()=>{ $("q").value=""; refreshList("open"); };
$("btnClosed").onclick=()=>{ $("q").value=""; refreshList("closed"); };
$("btnRefresh").onclick=()=>refreshList();

// init
(async function(){
  const ok=await diag();
  if(!ok) return;
  await refreshList("open");
})();
</script>
</body>
</html>
